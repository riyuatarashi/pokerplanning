// Feature: session management
(function(global){ const PP=global.PlanningPoker=global.PlanningPoker||{}; const { state, StorageManager, UI, VoteManager }=PP; let socket=null; PP.setSocketForSession=s=>{socket=s;}; PP.SessionManager={ create(name){ socket&&socket.emit('createSession',{sessionName:name}); }, join(id){ socket&&socket.emit('joinSession',{sessionId:id,clientId:state.clientId,displayName:state.displayName}); }, registerEvents(){ if(!socket)return; socket.on('sessionCreated',({sessionId,sessionName})=>{ state.sessionId=sessionId; state.sessionName=sessionName; StorageManager.persistSession(); this.join(sessionId); }); socket.on('sessionJoined',({sessionId,sessionName,roundId})=>{ state.sessionId=sessionId; state.sessionName=sessionName; state.roundId=roundId; state.revealed=false; state.joined=true; StorageManager.persistSession(); UI.updateSessionHeader(); UI.showScreen(PP.refs.pokerScreen); VoteManager.loadCards(); setTimeout(()=>VoteManager.restoreVote(),75); }); socket.on('state',(data)=>{ VoteManager.renderResults(data); if(data.votes[state.clientId]){ const sv=data.votes[state.clientId].vote; if(sv!==null&&sv!==state.selectedValue){ state.selectedValue=sv; StorageManager.saveVote(state.sessionId,state.roundId,sv); UI.restoreSelection(); } } }); socket.on('error',({message})=>{ UI.toast(message,'error'); if(/Session not found/i.test(message)){ StorageManager.clearSession(); state.sessionId=null; state.sessionName=''; state.roundId=null; state.selectedValue=null; state.joined=false; UI.showScreen(PP.refs.setupScreen); } }); socket.on('full',({message})=>{ PP.refs.messageEl&&(PP.refs.messageEl.textContent=message,PP.refs.messageEl.classList.remove('hidden')); PP.refs.revealBtn&&(PP.refs.revealBtn.disabled=true); PP.refs.resetBtn&&(PP.refs.resetBtn.disabled=true); }); socket.on('connect',()=>{ if(state.sessionId&&state.displayName) this.join(state.sessionId); }); socket.on('disconnect',()=>UI.toast('Connection lost. Reconnecting...','error')); socket.on('reconnect',()=>UI.toast('Reconnected successfully!','success')); } };})(window);

